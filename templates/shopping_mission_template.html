<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Report Integrato ‚Äì Missione Spesa & Anomalie</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#101a33; --text:#e8ecff; --muted:#a8b3e6; --line:rgba(255,255,255,.10);
      --good:#26d07c; --warn:#ffcc66; --bad:#ff5c77; --accent:#7aa2ff;
      --c1:#7aa2ff; --c2:#ffd166; --c3:#2dd4bf; --c4:#f97316; --c5:#a78bfa; --c6:#fb7185;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, sans-serif;
      background: radial-gradient(1200px 700px at 10% 0%, rgba(122,162,255,.08), transparent 55%), var(--bg);
      color:var(--text); line-height:1.5;
    }
    .wrap{max-width:1300px;margin:0 auto;padding:25px 15px 60px}
    
    /* Header & Action Bar */
    .top-nav{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;
      padding:20px; border:1px solid var(--line); background:rgba(16,26,51,.5); border-radius:18px; backdrop-filter: blur(10px);
      margin-bottom:20px;
    }
    .title h1{margin:0;font-size:22px;color:#fff}
    .tag-critical{background:rgba(255,92,119,0.15); color:var(--bad); padding:6px 14px; border-radius:999px; font-size:11px; font-weight:bold; border:1px solid var(--bad)}
    .btn-pdf{background:var(--accent); color:#0b1020; border:none; padding:8px 18px; border-radius:8px; font-weight:bold; cursor:pointer}

    /* Grid System */
    .grid{display:grid; gap:16px; grid-template-columns: repeat(12, 1fr)}
    .card{
      grid-column: span 12; border:1px solid var(--line); background:rgba(16,26,51,.7); 
      border-radius:18px; padding:20px; box-shadow: 0 10px 30px rgba(0,0,0,.2);
    }
    @media(min-width: 900px){ .c-6{grid-column: span 6} .c-8{grid-column: span 8} .c-4{grid-column: span 4} }

    /* KPIs & Tables */
    .kpi-grid{display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom:15px}
    .kpi{border:1px solid var(--line); border-radius:14px; padding:15px; background:rgba(255,255,255,0.03)}
    .kpi .lbl{color:var(--muted); font-size:11px; text-transform: uppercase}
    .kpi .val{font-size:22px; font-weight:bold; margin-top:5px}

    .table-container { overflow-x: auto; margin-top:10px}
    table{width:100%; border-collapse:collapse}
    th{text-align:left; font-size:10px; color:var(--muted); padding:10px; border-bottom:1px solid var(--line); text-transform:uppercase}
    td{padding:10px; border-bottom:1px solid rgba(255,255,255,.05); font-size:13px}
    .num{text-align:right; font-family: monospace}
    .high-risk{color:var(--bad); font-weight:bold}
    .period-sep { background: rgba(122,162,255,0.05); color: var(--accent); font-weight: bold; font-size: 11px; }

    /* Charts & Visuals */
    canvas{width:100%; height:280px; margin-top:10px; display:block}
    .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:15px}
    .chip{display:flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:rgba(255,255,255,.05); font-size:10px; color:var(--muted)}
    .dot{width:7px; height:7px; border-radius:50%}

    .top-item{display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--line)}
    .top-item:last-child{border-bottom:none}

    @media print {
      .btn-pdf { display:none }
      body { background: #fff; color: #000 }
      .card { border: 1px solid #ddd; box-shadow: none; break-inside: avoid }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top-nav">
      <div class="title">
        <h1 id="dynTitle">Analisi Missione Spesa & Anomalie</h1>
        <p id="dynSubtitle" style="color:var(--muted); font-size:14px">Performance Operativa e Audit Statistici</p>
      </div>
      <div style="display:flex; gap:10px; align-items:center">
        <div class="tag-critical">LIVELLO RISCHIO: MONITORAGGIO</div>
        <button class="btn-pdf" onclick="window.print()">Esporta PDF</button>
      </div>
    </div>

    <div class="grid">
      <div class="card c-8">
        <h2>Riepilogo Performance</h2>
        <div class="kpi-grid" id="kpiContainer"></div>
        <div id="narrative" style="font-size:13px; padding:12px; background:rgba(122,162,255,0.05); border-radius:10px; border:1px solid rgba(122,162,255,0.2)"></div>
      </div>

      <div class="card c-4">
        <h2>üìä Performance Casse</h2>
        <div class="table-container">
          <table>
            <thead><tr><th>ID Cassa</th><th class="num">Scostam.</th><th class="num">Rischio</th></tr></thead>
            <tbody id="cashierBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card c-6">
        <h2>Trend Fatturato (‚Ç¨)</h2>
        <canvas id="revChart"></canvas>
      </div>
      <div class="card c-6">
        <h2>Trend Traffico (Scontrini)</h2>
        <canvas id="rcptChart"></canvas>
      </div>

      <div class="card c-8">
        <h2>Mix Missioni (% Fatturato)</h2>
        <canvas id="shareChart"></canvas>
        <div class="legend" id="legendContainer"></div>
      </div>

      <div class="card c-4">
        <h2>Top Missioni (Valore)</h2>
        <div id="topMissionList"></div>
      </div>

      <div class="card">
        <h2>üçé Audit Pesa Ortofrutta (Dettaglio Anomalie)</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Data</th><th>Scontrino</th><th>Tipo</th><th>Barcode</th><th class="num">Store</th></tr>
            </thead>
            <tbody id="produceBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <p style="text-align:center; color:var(--muted); font-size:11px; margin-top:40px">
      Generato da Sistema Gemini Flash 2026 ‚Ä¢ Log in English Raw ‚Ä¢ Sincronizzazione Real-time
    </p>
  </div>

  <script>
    const data = {{DATA_PLACEHOLDER}};

    const missionColors = {
      "Spesa Standard Mista": "#7aa2ff",
      "Spesa Settimanale di Scorta": "#ffd166",
      "Convenienza Rapida": "#2dd4bf",
      "B2B / Ingrosso Outlier": "#f97316",
      "Fresco Quotidiano": "#a78bfa",
      "Premium / Specialit√† Singolo Articolo": "#fb7185"
    };

    const eur = (v) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(v);
    const num = (v) => new Intl.NumberFormat('it-IT').format(v);
    const monthLabel = (str) => {
      const d = new Date(str + "-01");
      return d.toLocaleDateString('it-IT', { month: 'short', year: 'numeric' });
    };

    function init() {
      const insights = data.monthly_insights || [];
      const mTotals = insights.map(m => {
        const r = m.results.reduce((s, x) => s + x.total_mission_revenue, 0);
        const c = m.results.reduce((s, x) => s + x.receipt_count, 0);
        return { period: m.period, rev: r, rcp: c };
      });

      renderKPIs(mTotals);
      renderTrends(insights, mTotals);
      renderAnomalies();
      renderTopMissions(insights);
    }

    function renderKPIs(mList) {
      const totalRev = mList.reduce((s, x) => s + x.rev, 0);
      const totalRcp = mList.reduce((s, x) => s + x.rcp, 0);
      document.getElementById('kpiContainer').innerHTML = `
        <div class="kpi"><div class="lbl">Fatturato</div><div class="val">${eur(totalRev)}</div></div>
        <div class="kpi"><div class="lbl">Scontrini</div><div class="val">${num(totalRcp)}</div></div>
        <div class="kpi"><div class="lbl">ATV Medio</div><div class="val">${eur(totalRev/totalRcp)}</div></div>
      `;
      document.getElementById('narrative').innerHTML = `<b>Executive Summary:</b> Analisi condotta su ${mList.length} mesi. Lo scontrino medio (ATV) si attesta a ${eur(totalRev/totalRcp)}.`;
    }

    function renderTrends(insights, mTotals) {
      const labels = mTotals.map(m => monthLabel(m.period));
      drawAxisLine('revChart', labels, mTotals.map(m => m.rev), '#7aa2ff', '‚Ç¨');
      drawAxisLine('rcptChart', labels, mTotals.map(m => m.rcp), '#2dd4bf', '');
      
      const keys = Object.keys(missionColors);
      const stack = insights.map(m => {
        const row = {};
        keys.forEach(k => {
          const f = m.results.find(r => r.shopping_mission === k);
          row[k] = f ? f.revenue_share_pct : 0;
        });
        return row;
      });
      drawStacked('shareChart', labels, stack, keys);
      
      const leg = document.getElementById('legendContainer');
      leg.innerHTML = Object.entries(missionColors).map(([n,c]) => `
        <div class="chip"><span class="dot" style="background:${c}"></span>${n}</div>
      `).join('');
    }

    // Improved Charting with Axes
    function drawAxisLine(id, labels, dataPoints, color, unit) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      canvas.width = canvas.offsetWidth * dpr;
      canvas.height = 280 * dpr;
      ctx.scale(dpr, dpr);

      const w = canvas.offsetWidth, h = 280, pad = 50;
      const max = Math.max(...dataPoints) * 1.2 || 1;
      const stepX = (w - pad * 2) / (labels.length - 1 || 1);

      // Draw Grid & Y-Axis
      ctx.strokeStyle = "rgba(255,255,255,0.05)";
      ctx.setLineDash([5, 5]);
      for(let i=0; i<=4; i++) {
        const y = h - pad - (i * (h - pad * 2) / 4);
        ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w - pad, y); ctx.stroke();
        ctx.fillStyle = "var(--muted)"; ctx.font = "9px sans-serif";
        ctx.fillText(num(Math.round(max * i / 4)) + unit, 5, y + 3);
      }
      ctx.setLineDash([]);

      // Draw Line
      ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.beginPath();
      dataPoints.forEach((p, i) => {
        const x = pad + (i * stepX), y = (h - pad) - ((p / max) * (h - pad * 2));
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // Labels
      labels.forEach((l, i) => {
        ctx.fillText(l, pad + (i * stepX) - 15, h - 15);
      });
    }

    function drawStacked(id, labels, datasets, keys) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      canvas.width = canvas.offsetWidth * dpr; canvas.height = 280 * dpr;
      ctx.scale(dpr, dpr);
      const w = canvas.offsetWidth, h = 280, pad = 50;
      const barW = (w - pad * 2) / labels.length * 0.5;
      const stepX = (w - pad * 2) / labels.length;

      labels.forEach((l, i) => {
        let curY = h - pad;
        const x = pad + (i * stepX) + (stepX - barW)/2;
        keys.forEach(k => {
          const hBar = (datasets[i][k] / 100) * (h - pad * 2);
          ctx.fillStyle = missionColors[k];
          ctx.fillRect(x, curY - hBar, barW, hBar);
          curY -= hBar;
        });
        ctx.fillStyle = "var(--muted)"; ctx.fillText(l, x, h - 15);
      });
    }

    function renderAnomalies() {
      const cBody = document.getElementById('cashierBody');
      if(data.cashier_anomalies) {
        cBody.innerHTML = data.cashier_anomalies.map(item => `
          <tr><td><b>${item.id}</b></td><td class="num">${item.deviation}%</td>
          <td class="num ${item.risk > 70 ? 'high-risk':''}">${item.risk}/100</td></tr>
        `).join('');
      }

      const pBody = document.getElementById('produceBody');
      const alerts = data.produce_alerts || data.alerts || [];
      let html = "";
      alerts.forEach(period => {
        html += `<tr class="period-sep"><td colspan="5">Mese: ${period.period}</td></tr>`;
        html += period.details.map(d => `
          <tr><td>${d.date_str}</td><td>${d.receipt_id.split('-').pop()}</td>
          <td>${d.scontrinoTipo}</td><td>${d.scontrinoBarcode}</td><td class="num">${d.store_id}</td></tr>
        `).join('');
      });
      pBody.innerHTML = html || '<tr><td colspan="5">Nessun dato</td></tr>';
    }

    function renderTopMissions(insights) {
      const map = {};
      insights.forEach(m => m.results.forEach(r => {
        map[r.shopping_mission] = (map[r.shopping_mission] || 0) + r.total_mission_revenue;
      }));
      const sorted = Object.entries(map).sort((a,b) => b[1] - a[1]).slice(0,5);
      document.getElementById('topMissionList').innerHTML = sorted.map(([n,v]) => `
        <div class="top-item"><b>${n}</b><span class="num" style="color:var(--good)">${eur(v)}</span></div>
      `).join('');
    }

    init();
  </script>
</body>
</html>